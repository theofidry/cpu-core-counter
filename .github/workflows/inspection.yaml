name: "Inspection"

on: # yamllint disable-line rule:truthy
    pull_request: null
    push:
        branches:
            - "main"
    schedule:
        - cron: "0 0 1 * *"

jobs:
    ubuntu-inspection:
        name: "Ubuntu Inspection"
        runs-on: "ubuntu-latest"
        strategy:
            matrix:
                php-version:
                    - "8.3"
        steps:
            -   name: "Checkout"
                uses: "actions/checkout@v3.1.0"

            -   name: "Set up PHP"
                uses: "shivammathur/setup-php@2.22.0"
                with:
                    coverage: "xdebug"
                    php-version: "${{ matrix.php-version }}"
                    tools: "phive"

            -   name: "Install Composer dependencies"
                uses: "ramsey/composer-install@v2"

            -   name: "Execute finders"
                run: "php bin/execute.php"

            -   name: "Run diagnosis"
                run: "php bin/diagnose.php"

    windows-inspection:
        name: "Windows Inspection"
        runs-on: "windows-latest"
        strategy:
            matrix:
                php-version:
                    - "8.3"
        steps:
            -   name: "Checkout"
                uses: "actions/checkout@v3.1.0"

            -   name: "Set up PHP"
                uses: "shivammathur/setup-php@2.22.0"
                with:
                    coverage: "xdebug"
                    php-version: "${{ matrix.php-version }}"
                    tools: "phive"

            -   name: "Install Composer dependencies"
                uses: "ramsey/composer-install@v2"

            -   name: "Execute finders"
                run: "php bin/execute.php"

            -   name: "Run diagnosis"
                run: "php bin/diagnose.php"

    osx-inspection:
        name: "OSX Inspection"
        runs-on: "macos-latest"
        strategy:
            matrix:
                php-version:
                    - "8.3"
        steps:
            -   name: "Checkout"
                uses: "actions/checkout@v3.1.0"

            -   name: "Set up PHP"
                uses: "shivammathur/setup-php@2.22.0"
                with:
                    coverage: "xdebug"
                    php-version: "${{ matrix.php-version }}"
                    tools: "phive"

            -   name: "Install Composer dependencies"
                uses: "ramsey/composer-install@v2"

            -   name: "Execute finders"
                run: "php bin/execute.php"

            -   name: "Run diagnosis"
                run: "php bin/diagnose.php"

    osx-m1-inspection:
        name: "OSX M1 Inspection"
        runs-on: " 	macos-14"
        strategy:
            matrix:
                php-version:
                    - "8.3"
        steps:
            -   name: "Checkout"
                uses: "actions/checkout@v3.1.0"

            -   name: "Set up PHP"
                uses: "shivammathur/setup-php@2.22.0"
                with:
                    coverage: "xdebug"
                    php-version: "${{ matrix.php-version }}"
                    tools: "phive"

            -   name: "Install Composer dependencies"
                uses: "ramsey/composer-install@v2"

            -   name: "Execute finders"
                run: "php bin/execute.php"

            -   name: "Run diagnosis"
                run: "php bin/diagnose.php"

    # This is a "trick", a meta task which does not change, and we can use in
    # the protected branch rules as opposed to the tests one above which
    # may change regularly.
    validate-tests:
        name: "Inspection status"
        runs-on: "ubuntu-latest"
        needs:
            - "ubuntu-inspection"
            - "windows-inspection"
            - "osx-inspection"
            - "osx-m1-inspection"
        if: "always()"
        steps:
            - name: "Successful run"
              if: "${{ !(contains(needs.*.result, 'failure')) }}"
              run: "exit 0"

            - name: "Failing run"
              if: "${{ contains(needs.*.result, 'failure') }}"
              run: "exit 1"
